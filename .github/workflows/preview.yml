on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches:
            - dev
permissions:
    contents: read
    pull-requests: write
jobs:
    check-lint:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup environment
              uses: ./.github/actions/setup-environment
              with:
                  node-version: "20.x"
                  working-directory: ./health-pal

            - name: Run lint
              working-directory: ./health-pal
              run: yarn lint

    check-unit-test:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup environment
              uses: ./.github/actions/setup-environment
              with:
                  node-version: "20.x"
                  working-directory: ./health-pal

            - name: Run unit test
              working-directory: ./health-pal
              run: yarn test

    build_and_deploy_development:
        runs-on: ubuntu-latest
        needs: [check-lint, check-unit-test]
        timeout-minutes: 60
        environment: Development

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup environment
              uses: ./.github/actions/setup-environment
              with:
                  node-version: "20.x"
                  working-directory: ./health-pal
                  expo-token: ${{ secrets.EXPO_TOKEN }}

            # - name: üöÄ Build app
            #   run: eas build --platform android --profile development --local --output ${{ github.workspace }}/app-release.apk --non-interactive
            #   working-directory: ./health-pal
            #   env:
            #       EXPO_PUBLIC_APP_TOKEN: ${{ secrets.EXPO_PUBLIC_APP_TOKEN }}
            #       EXPO_PUBLIC_API_ENDPOINT: ${{ secrets.EXPO_PUBLIC_API_ENDPOINT }}
            #       EXPO_PUBLIC_CLOUDINARY_DOMAIN: ${{ secrets.EXPO_PUBLIC_CLOUDINARY_DOMAIN }}

            # - name: Upload artifact
            #   uses: actions/upload-artifact@v4
            #   with:
            #       name: app-release-development
            #       path: ${{ github.workspace }}/app-release.apk
            #       retention-days: 7

            - name: Create EAS preview
              #   if: success()
              id: eas-preview
              uses: expo/expo-github-action/preview@v8
              with:
                  working-directory: ./health-pal
                  run: eas update --auto --channel development
              env:
                  EXPO_PUBLIC_APP_TOKEN: ${{ secrets.EXPO_PUBLIC_APP_TOKEN }}
                  EXPO_PUBLIC_API_ENDPOINT: ${{ secrets.EXPO_PUBLIC_API_ENDPOINT }}
                  EXPO_PUBLIC_CLOUDINARY_DOMAIN: ${{ secrets.EXPO_PUBLIC_CLOUDINARY_DOMAIN }}

            - name: Post PR comment
              if: always()
              uses: actions/github-script@v7
              with:
                  script: |
                      const buildStatus = ${{ job.status == 'success' }} ? '‚úÖ Build completed successfully! Check artifacts for APK.' : '‚ùå Build failed. Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
                      const easStatus = ${{ steps.eas-preview.outcome == 'success' }} ? '‚úÖ EAS Update completed! Preview ready.' : '‚ùå EAS Update failed or skipped. Check logs.';
                      github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        body: `${buildStatus}\n${easStatus}`
                      });
